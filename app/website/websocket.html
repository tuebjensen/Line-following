<script type="module">
    import { BehaviorSubject, fromEvent, Observable, concatWith, mergeMap, switchMap, of, tap, throwError, retry, map, filter, merge, share, combineLatest } from 'https://cdn.skypack.dev/pin/rxjs@v7.5.7-j3yWv9lQY9gNeD9CyX5Y/mode=imports,min/optimized/rxjs.js'

    const socket$ = new Observable((subscriber) => {
            const socket = new WebSocket('ws://' + location.host + '/ws')
            subscriber.next(socket)
            subscriber.complete()
        }).pipe(
            switchMap(socket => 
                fromEvent(socket, 'open').pipe(
                    tap(() => {
                        socket.onmessage = console.log
                        console.log('websocket opened')
                    })),
                    map(() => socket)
            ),
            share()).subscribe(() => {})
</script>