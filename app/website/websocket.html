<script type="module">
    import { BehaviorSubject, fromEvent, Observable, concatWith, mergeMap, switchMap, of, tap, throwError, retry, map, filter, merge, share, combineLatest } from 'https://cdn.skypack.dev/pin/rxjs@v7.5.7-j3yWv9lQY9gNeD9CyX5Y/mode=imports,min/optimized/rxjs.js'

    const socket$ = new Observable((subscriber) => {
            const socket = new WebSocket('ws://' + location.host + '/ws')
            subscriber.next(socket)
            subscriber.complete()
        }).pipe(
            tap(socket => console.log(socket)),
            switchMap(socket => merge(
                // emit the socket when it becomes open
                fromEvent(socket, 'open').pipe(
                    tap(() => {
                        socket.onmessage = console.log
                        console.log('websocket opened')
                    })),
                    map(() => socket),
                // emit null if the socket is closed
                fromEvent(socket, 'close').pipe(
                    tap(() => console.log('websocket closed')),
                    map(() => null)))),
            retry({
                delay: 3000
            }),
            share()).subscribe(() => {})
</script>